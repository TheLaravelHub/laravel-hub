name: Deploy To Server

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: "Select the GitHub Environment to update"
        type: choice
        options: [Production, Development]
        required: true

jobs:
  create-env:
    name: Generate .env on Server
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch'
      && github.event.inputs.environment
      || (github.ref_name == 'main' && 'Production' || 'Development') }}

    env:
      ENVIRONMENT_NAME: ${{ github.event_name == 'workflow_dispatch'
        && github.event.inputs.environment
        || (github.ref_name == 'main' && 'Production' || 'Development') }}
      BRANCH: ${{ github.ref_name }}

    steps:
      - name: Generate .env via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_SSH_HOST }}
          username: ${{ secrets.DO_SSH_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cat <<EOF > ${{ secrets.DEPLOY_PATH }}/.env
            APP_NAME=${{ vars.APP_NAME }}
            APP_ENV=${{ vars.APP_ENV }}
            APP_KEY=${{ secrets.APP_KEY }}
            APP_DEBUG=${{ vars.APP_DEBUG }}
            APP_TIMEZONE=${{ vars.APP_TIMEZONE }}
            APP_URL=${{ vars.APP_URL }}
            MAIN_DOMAIN=${{ vars.MAIN_DOMAIN }}
            APP_DOMAIN=${{ vars.APP_DOMAIN }}

            APP_LOCALE=${{ vars.APP_LOCALE }}
            APP_FALLBACK_LOCALE=${{ vars.APP_FALLBACK_LOCALE }}
            APP_FAKER_LOCALE=${{ vars.APP_FAKER_LOCALE }}
            APP_MAINTENANCE_DRIVER=${{ vars.APP_MAINTENANCE_DRIVER }}

            PHP_CLI_SERVER_WORKERS=${{ vars.PHP_CLI_SERVER_WORKERS }}
            BCRYPT_ROUNDS=${{ secrets.BCRYPT_ROUNDS }}

            LOG_CHANNEL=${{ vars.LOG_CHANNEL }}
            LOG_STACK=${{ vars.LOG_STACK }}
            LOG_DEPRECATIONS_CHANNEL=${{ vars.LOG_DEPRECATIONS_CHANNEL }}
            LOG_LEVEL=${{ vars.LOG_LEVEL }}

            DB_CONNECTION=pgsql
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            SESSION_DRIVER=${{ vars.SESSION_DRIVER }}
            SESSION_LIFETIME=${{ vars.SESSION_LIFETIME }}
            SESSION_ENCRYPT=${{ vars.SESSION_ENCRYPT }}
            SESSION_PATH=${{ vars.SESSION_PATH }}
            SESSION_DOMAIN=${{ vars.SESSION_DOMAIN }}
            SANCTUM_STATEFUL_DOMAINS=${{ vars.SANCTUM_STATEFUL_DOMAINS }}
            SESSION_COOKIE=${{ secrets.SESSION_COOKIE }}
            SESSION_SECURE_COOKIE=${{ secrets.SESSION_SECURE_COOKIE }}

            BROADCAST_CONNECTION=${{ vars.BROADCAST_CONNECTION }}
            FILESYSTEM_DISK=${{ vars.FILESYSTEM_DISK }}
            QUEUE_CONNECTION=${{ vars.QUEUE_CONNECTION }}
            CACHE_STORE=${{ secrets.CACHE_STORE }}
            CACHE_PREFIX=${{ secrets.CACHE_PREFIX }}
            REDIS_DB=${{ secrets.REDIS_DB }}
            HORIZON_PREFIX=${{ secrets.HORIZON_PREFIX }}

            MEMCACHED_HOST=${{ vars.MEMCACHED_HOST }}
            REDIS_CLIENT=${{ vars.REDIS_CLIENT }}
            REDIS_HOST=${{ vars.REDIS_HOST }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}

            MAIL_MAILER=${{ vars.MAIL_MAILER }}
            MAIL_FROM_ADDRESS=${{ vars.MAIL_FROM_ADDRESS }}
            MAIL_FROM_NAME=${{ vars.APP_NAME }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}

            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}
            AWS_BUCKET=${{ secrets.AWS_BUCKET }}
            AWS_URL=${{ secrets.AWS_URL }}
            AWS_USE_PATH_STYLE_ENDPOINT=${{ secrets.AWS_USE_PATH_STYLE_ENDPOINT }}

            VITE_APP_NAME=${{ vars.APP_NAME }}

            MODEL_STATUS_COLUMN=${{ vars.MODEL_STATUS_COLUMN }}
            MODEL_STATUS_COLUMN_LENGTH=${{ vars.MODEL_STATUS_COLUMN_LENGTH }}
            MODEL_STATUS_ACTIVE=${{ vars.MODEL_STATUS_ACTIVE }}
            MODEL_STATUS_INACTIVE=${{ vars.MODEL_STATUS_INACTIVE }}

            GHUB_TOKEN=${{ secrets.GHUB_TOKEN }}

            SCOUT_DRIVER=${{ vars.SCOUT_DRIVER }}
            SCOUT_QUEUE=${{ vars.SCOUT_QUEUE }}

            ALGOLIA_APP_ID=${{ secrets.ALGOLIA_APP_ID }}
            ALGOLIA_SECRET=${{ secrets.ALGOLIA_SECRET }}

            MIXPANEL_TOKEN=${{ secrets.MIXPANEL_TOKEN }}
            VITE_MIXPANEL_TOKEN=${{ secrets.MIXPANEL_TOKEN }}

            GHUB_ID=${{ secrets.GHUB_ID }}
            GHUB_SECRET=${{ secrets.GHUB_SECRET }}
            GHUB_URL=${{ vars.GHUB_URL }}

            SENTRY_LARAVEL_DSN=${{ secrets.SENTRY_LARAVEL_DSN }}
            SENTRY_SEND_DEFAULT_PII=${{ secrets.SENTRY_SEND_DEFAULT_PII }}
            SENTRY_TRACES_SAMPLE_RATE=${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}

            TURNSTILE_SITE_KEY=${{ secrets.TURNSTILE_SITE_KEY }}
            TURNSTILE_SECRET_KEY=${{ secrets.TURNSTILE_SECRET_KEY }}
            VITE_TURNSTILE_SITE_KEY=${{ secrets.TURNSTILE_SITE_KEY }}
            VITE_TURNSTILE_SECRET_KEY=${{ secrets.TURNSTILE_SECRET_KEY }}

            CHROME_PATH=${{ secrets.CHROME_PATH }}
            BROWSERSHOT_USER_DATA_DIR=${{ secrets.BROWSERSHOT_USER_DATA_DIR }}
            EOF

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: create-env
    # Inline the same expression here as well
    environment: ${{ github.event_name == 'workflow_dispatch'
      && github.event.inputs.environment
      || (github.ref_name == 'main' && 'Production' || 'Development') }}

    env:
      ENVIRONMENT_NAME: ${{ github.event_name == 'workflow_dispatch'
        && github.event.inputs.environment
        || (github.ref_name == 'main' && 'Production' || 'Development') }}
      BRANCH: ${{ github.ref_name }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_SSH_HOST }}
          username: ${{ secrets.DO_SSH_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            ENVIRONMENT="${{ env.ENVIRONMENT_NAME }}"
            BRANCH="${{ env.BRANCH }}"
            PM2_NAME="${ENVIRONMENT,,}-ssr"

            cd ${{ secrets.DEPLOY_PATH }}
            git reset --hard
            git pull origin "$BRANCH"

            if [ "$ENVIRONMENT" = "Production" ]; then
              COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader
            else
              COMPOSER_ALLOW_SUPERUSER=1 composer install
            fi

            php artisan migrate --force

            npm ci
            npm run build:ssr

            if pm2 list | grep -q production-ssr; then
              pm2 restart production-ssr
            else
              pm2 start bootstrap/ssr/ssr.js --name=production-ssr
            fi

            php artisan optimize:clear
            php artisan optimize
            php artisan horizon:terminate

            systemctl restart laravel-ssr
